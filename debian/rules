#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

#Thanks to Paolo Molaro <lupus@debian.org> and heartbeat_0.4.6-2.diff

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

cfg:=--prefix=/usr --sysconfdir=/etc --localstatedir=/var \
  --mandir=/usr/share/man

# These are used for cross-compiling and for saving the configure script
# from having to guess our platform (since we know it already)
DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

CFLAGS = -Wall -g

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
       CFLAGS += -O0
else
       CFLAGS += -O2
endif
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
       INSTALL_PROGRAM += -s
endif

DTMP:=`pwd`/debian/tmp

build: checkbuild build-stamp
build-stamp:
	dh_testdir
	./configure $(cfg)
	$(MAKE)
	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	# Add here commands to clean up after the build process.
	-$(MAKE) clean MAKE=make
	-$(MAKE) distclean MAKE=make
	dh_clean build-stamp install-stamp
	rm -f debian/init debian/*.debhelper debian/*.substvars
	rm -r -f debian/heartbeat debian/heartbeat-dev debian/ldirectord \
		debian/libpils0 debian/libpils-dev \
		debian/libstonith0 debian/libstonith-dev debian/stonith \
		debian/tmp


install: build install-stamp
install-stamp:
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs
	$(MAKE) install DESTDIR=$(DTMP) \
	  MAKE=make \
	  docdir=/usr/share/doc/heartbeat 
	find $(DTMP)/usr/share/man -type f | xargs gzip -v --best
	install -c -m 755 heartbeat/init.d/heartbeat \
                $(DTMP)/etc/init.d/heartbeat
	-mkdir -p $(DTMP)/usr/share/doc/ldirectord/
	install -c -m 644 ldirectord/ldirectord.cf \
	  $(DTMP)/usr/share/doc/ldirectord/
	-mkdir -p $(DTMP)/etc/init.d
	install -c -m 755 ldirectord/init.d/ldirectord \
		$(DTMP)/etc/init.d/ldirectord
	cd $(DTMP)/etc/ha.d/resource.d \
	  && ln -s /usr/sbin/ldirectord ldirectord
	cd $(DTMP)/etc/ && ln -s ha.d heartbeat
	dh_movefiles --source=debian/tmp

binary: build install
	dh_testdir
	dh_testroot
	dh_installdebconf	
	dh_installdocs
	dh_installexamples
#	dh_installmenu
#	dh_installemacsen
#	dh_installpam
	dh_installinit -n -u 'defaults 20 32'
#	dh_installcron
	dh_installman
#	dh_installinfo
#	dh_undocumented
	dh_installchangelogs `pwd`/debian/heartbeat/usr/share/doc/heartbeat/ChangeLog
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
#	dh_suidregister
	dh_makeshlibs -V
	dh_installdeb
	dh_perl
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb
	@echo "Any unpackaged files follow (.a and .la files omitted):"
	@cd $(DTMP) && find ./ \! -type d | egrep -v \\\.l?a

checkbuild:
	chmod u+x ./debian/dpkg-checkbuild
	./debian/dpkg-checkbuild debian/control

.PHONY: build clean binary install checkbuild
