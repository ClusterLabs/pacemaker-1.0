#!/bin/sh
# The purpose of this script is to break or fix the communication in the cluster.
#
HADIR=@sysconfdir@/ha.d
HBSCRIPT=@INITDIR@/heartbeat@INIT_EXT@

LIBDIR=@libdir@/
HBLIB=$LIBDIR/heartbeat
TESTFILE=OnlyForTesting

USAGE="Usage: 'TestHeartbeatComm break-communication allow-nodes-list|fix-communication|delete-testingfile'"

if 
  [ $# -lt 1 ]
then
  echo "$USAGE";
  exit 1;
fi

cd @sysconfdir@/ha.d

# Create OnlyForTesting File. It is invoked by ParseTestOpts() in heartbeat.c

GenerateTestingFile(){
save_IFS=$IFS
IFS=';'
  cat <<EOF >$TESTFILE
xmitloss=1
rcvloss=1
allownodes=$*;
EOF
IFS=$save_IFS
}

DeleteTestingFile(){
  rm -f $TESTFILE
  echo "DeleteTestFileOK"
}

HBReload(){
  $HBSCRIPT reload
}


OPT=$1
case "$OPT" in
  break-communication)
	shift
	GenerateTestingFile $@
	HBReload
	;;
  fix-communication)
	DeleteTestingFile
	HBReload
	;;
  delete-testingfile)
	DeleteTestingFile
	;;
  *)
	echo "$USAGE"
	;;
esac

exit $?
